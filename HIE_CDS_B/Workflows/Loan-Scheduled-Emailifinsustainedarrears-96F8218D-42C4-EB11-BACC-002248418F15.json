{"properties":{"connectionReferences":{"shared_commondataserviceforapps_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnLoan"},"api":{"name":"shared_commondataserviceforapps"}},"shared_office365_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnOffice365Outlook3"},"api":{"name":"shared_office365"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"},"Loan Arrears Threshold":{"defaultValue":"10","type":"String","metadata":{"schemaName":"leidos_LoanArrearsdays","description":"Number of days before loan arrears are flagged"}}},"triggers":{"Recurrence":{"recurrence":{"frequency":"Day","interval":1,"timeZone":"UTC","schedule":{"hours":["2"]}},"type":"Recurrence"}},"actions":{"List_Loans":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_loans","fetchXml":"<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\" >\n    <entity name=\"leidos_loan\" >\n        <attribute name=\"statuscode\" />\n        <attribute name=\"leidos_loanreference\" />\n        <attribute name=\"leidos_interestdue\" />\n        <attribute name=\"leidos_dateofnextrepayment\" />\n        <attribute name=\"leidos_capitaloutstanding\" />\n        <attribute name=\"leidos_loanid\" />\n        <attribute name=\"leidos_project\" />\n        <attribute name=\"leidos_interestarrears\" />\n        <attribute name=\"leidos_capitalarrears\" />\n        <attribute name=\"leidos_datewentintoarrears\" />\n        <order attribute=\"leidos_loanreference\" descending=\"false\" />\n        <filter type=\"and\" >\n            <condition attribute=\"leidos_datewentintoarrears\" operator=\"olderthan-x-days\" value=\"@{parameters('Loan Arrears Threshold')}\" />\n        </filter>\n        <link-entity name=\"leidos_project\" from=\"leidos_projectid\" to=\"leidos_project\" visible=\"false\" link-type=\"outer\" alias=\"proj\" >\n            <attribute name=\"ownerid\" />\n            <attribute name=\"leidos_parentaccount\" />\n        </link-entity>\n    </entity>\n</fetch>"},"authentication":"@parameters('$authentication')"}},"Compose":{"runAfter":{"List_Loans":["Succeeded"]},"type":"Compose","inputs":"@length(outputs('List_Loans')?['body/value'])"},"Condition":{"actions":{"Apply_to_each":{"foreach":"@outputs('List_Loans')?['body/value']","actions":{"Send_an_email_(V2)":{"runAfter":{"Get_Client_Record":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365_1","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@outputs('Get_owner_user_record')?['body/internalemailaddress']","emailMessage/Subject":"Missed Loan Repayment - @{outputs('Get_Client_Record')?['body/name']}  @{outputs('Get_Client_Record')?['body/leidos_accountreference']}","emailMessage/Body":"<p>Loan @{items('Apply_to_each')?['leidos_loanreference']} has been now been in arrears for longer than the threshold period.<br>\n<br>\nClient: @{outputs('Get_Client_Record')?['body/name']}<br>\nMyHIE Loan Ref: @{items('Apply_to_each')?['leidos_loanreference']}<br>\nCapital Arrears: £@{items('Apply_to_each')?['leidos_capitalarrears']}<br>\nInterest Outstanding: £@{items('Apply_to_each')?['leidos_interestarrears']}<br>\n<br>\nPlease liaise with the client to confirm the reason the repayment has not been received and provide an update to HIE Finance.</p>","emailMessage/Bcc":"callum.beveridge@leidos.com"},"authentication":"@parameters('$authentication')"}},"Update_a_row":{"runAfter":{"Send_an_email_(V2)":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_loans","recordId":"@items('Apply_to_each')?['leidos_loanid']","item/leidos_datewentintoarrears":"@addDays(utcnow(),mul(12,30))"},"authentication":"@parameters('$authentication')"}},"Get_Client_Record":{"runAfter":{"Account":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"accounts","recordId":"@outputs('Account')"},"authentication":"@parameters('$authentication')"}},"Owner":{"runAfter":{},"type":"Compose","inputs":"@items('Apply_to_each')?['proj.ownerid']"},"Get_owner_user_record":{"runAfter":{"Owner":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@outputs('Owner')"},"authentication":"@parameters('$authentication')"}},"Account":{"runAfter":{"Get_owner_user_record":["Succeeded"]},"type":"Compose","inputs":"@items('Apply_to_each')?['proj.leidos_parentaccount']"}},"runAfter":{},"type":"Foreach"}},"runAfter":{"Compose":["Succeeded"]},"expression":{"greater":["@outputs('Compose')",0]},"type":"If"}},"outputs":{}}},"schemaVersion":"1.0.0.0"}