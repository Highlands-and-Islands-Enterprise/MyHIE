var pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad=function(e){var t={};function i(n){if(t[n])return t[n].exports;var l=t[n]={i:n,l:!1,exports:{}};return e[n].call(l.exports,l,l.exports,i),l.l=!0,l.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var l in e)i.d(n,l,function(t){return e[t]}.bind(null,l));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([
/*!***************************************!*\
  !*** ./FileFieldTypeManager/index.ts ***!
  \***************************************/
/*! no static exports found */
/*! all exports used */
/*! ModuleConcatenation bailout: Module is not an ECMAScript module */function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.init=function(e,t,i,n){this._notifyOutputChanged=t,this._context=e,this._container=n,this._inputElementOnClick=this.inputFileOnClick.bind(this),this._showHideRelatedFilesOnClick=this.showHideRelatedFilesOnClick.bind(this,null),this._clientUrl=e.page.getClientUrl(),this._parentRecordId=e.mode.contextInfo.entityId,this._container=document.createElement("div"),this._fileUploadDiv=document.createElement("div"),this.getParams(),this._inputFileElement=document.createElement("input"),this._inputFileElement.setAttribute("type","file"),this._inputFileElement.setAttribute("name","Upload"),this._inputFileElement.setAttribute("id","FileFieldTypeManagerFileElement"),this._inputFileElement.setAttribute("class","FileFieldTypeManager-input-file"),this._inputFileElement.addEventListener("change",this._inputElementOnClick),this._inputLabelElement=document.createElement("label"),this._inputLabelElement.setAttribute("class","FileFieldTypeManager-file-upload"),this._inputLabelElement.setAttribute("id","FileFieldTypeManagerLabelElement"),this._inputLabelElement.setAttribute("style",""),this._fileUploadDiv.appendChild(this._inputFileElement),this._fileUploadDiv.appendChild(this._inputLabelElement);var l=document.createElement("div");l.setAttribute("class","showRelatedFiles-flexbox"),this._fileBlockIcon=document.createElement("img"),this.findAndSetImage("play",".png",this._fileBlockIcon),this._fileBlockText=document.createElement("span"),this._fileBlockText.innerText=this._showRelatedFilesText,this._fileBlockText.addEventListener("click",this._showHideRelatedFilesOnClick),l.appendChild(this._fileBlockIcon),l.appendChild(this._fileBlockText),this._fileListTable=document.createElement("table"),this._fileListTable.setAttribute("class","FileFieldTypeManager-table"),this._fileListTBody=document.createElement("tbody"),this._fileListTable.appendChild(this._fileListTBody),n.appendChild(this._fileUploadDiv),n.appendChild(l),n.appendChild(this._fileListTable),this._showFilesByDefault&&this.showHideRelatedFilesOnClick("table"),this.retrieveFileList()},e.prototype.updateView=function(e){this._context=e,this.retrieveFileList()},e.prototype.getOutputs=function(){return{}},e.prototype.destroy=function(){},e.prototype.getParams=function(){var e=this._context;this._fileEntityName=e.parameters.FileEntityName.raw,this._fileEntityNamePlural=e.parameters.FileEntityNamePlural.raw,this._typeOfFile=e.parameters.TypeOfFile.raw,this._fileFieldName=e.parameters.FileFieldName.raw,this._fileTypeFieldName=e.parameters.FileTypeFieldName.raw,this._mappingFieldToRetrieveFiles=e.parameters.MappingFieldToRetrieveFiles.raw,this._orderFilesBy=e.parameters.OrderFilesBy.raw,this._parentEntityNamePlural=e.parameters.ParentEntityNamePlural.raw,this._mainSubEntityFieldName=e.parameters.MainSubEntityFieldName.raw,this._showRelatedFilesText=e.parameters.ShowRelatedFilesText.raw,this._hideRelatedFilesText=e.parameters.HideRelatedFilesText.raw,this._areFilesStoredOnSubEntity=!(!e.parameters.AreFilesStoredOnSubEntity||!e.parameters.AreFilesStoredOnSubEntity.raw||"true"!==e.parameters.AreFilesStoredOnSubEntity.raw.toLowerCase()),this._showFilesByDefault=!(!e.parameters.ShowFilesByDefault||!e.parameters.ShowFilesByDefault.raw||"true"!==e.parameters.ShowFilesByDefault.raw.toLowerCase()),this._allowDeleteFile=!(!e.parameters.AllowDeleteOption||!e.parameters.AllowDeleteOption.raw||"true"!==e.parameters.AllowDeleteOption.raw.toLowerCase()),this._dateFormat=e.parameters.DateDisplayFormat.raw},e.prototype.isNullOrUndefined=function(e){return null==e||null==e},e.prototype.showHideRelatedFilesOnClick=function(e){var t=this._fileListTable.style.display,i="";this._fileBlockIcon.classList.remove("rotateimg90"),"table"==t?(i=this._showRelatedFilesText,this._fileBlockIcon.classList.remove("rotateimg90")):(i=this._hideRelatedFilesText,this._fileBlockIcon.classList.add("rotateimg90")),t="none"==t||""==t?"table":"none",this.isNullOrUndefined(e)||("table"==(t=e)?(i=this._hideRelatedFilesText,this._fileBlockIcon.classList.add("rotateimg90")):(i=this._showRelatedFilesText,this._fileBlockIcon.classList.remove("rotateimg90"))),this._fileListTable.style.display=t,this._fileBlockText.innerText=i},e.prototype.retrieveFileList=function(){var e,t,i=this,n=this._fileFieldName+"_name",l="?$filter="+(this._areFilesStoredOnSubEntity?"_"+(null===(e=i._mappingFieldToRetrieveFiles)||void 0===e?void 0:e.toString().toLowerCase())+"_value":null===(t=i._mappingFieldToRetrieveFiles)||void 0===t?void 0:t.toString().toLowerCase())+" eq "+i._parentRecordId;i.isNullOrUndefined(i._fileTypeFieldName)||(l+=" and "+i._fileTypeFieldName+" eq "+i._typeOfFile),i.isNullOrUndefined(i._orderFilesBy)||(l+="&$orderby="+i._orderFilesBy),i._areFilesStoredOnSubEntity?this._context.webAPI.retrieveMultipleRecords(i._fileEntityName,l).then((function(e){i._fileListTBody.innerHTML="",0==e.entities.length&&i.showHideRelatedFilesOnClick("none");for(var t=0;t<e.entities.length;t++){var l=e.entities[t];i.addFileToList(l,n)}i.findAndSetImageBackGround("browse",".png",i._inputLabelElement)}),(function(e){i._context.navigation.openAlertDialog(e.message),console.log(e.message)})):this._context.webAPI.retrieveRecord(i._fileEntityName,this._parentRecordId).then((function(e){i._fileListTBody.innerHTML="",i.isNullOrUndefined(e[i._fileFieldName])?i.showHideRelatedFilesOnClick("none"):(i.addFileToList(e,n),i.findAndSetImageBackGround("browse",".png",i._inputLabelElement))}),(function(e){i._context.navigation.openAlertDialog(e.message),console.log(e.message)}))},e.prototype.addFileToList=function(e,t){var i=this,n=document.createElement("tr"),l=e[i._fileEntityName+"id"],a=document.createElement("td"),r=document.createElement("a");r.setAttribute("id","filename_"+l),r.appendChild(document.createTextNode(e[t])),r.setAttribute("class","downloadFile"),r.addEventListener("click",(function(e){i.inputFileNameOnClick(e)})),a.appendChild(r),n.appendChild(a);var o=document.createElement("td"),s=document.createTextNode(e._createdby_value);o.appendChild(s);var d=document.createElement("td"),c=new Date(e.createdon),p=document.createTextNode(c.toLocaleDateString(i._dateFormat)+" "+c.toLocaleTimeString(i._dateFormat));if(d.appendChild(p),n.appendChild(d),i._allowDeleteFile){var u=document.createElement("td");i._fileDeleteIcon=document.createElement("img"),i._fileDeleteIcon.setAttribute("id","delete_"+l),i.findAndSetImage("delete",".png",i._fileDeleteIcon),i._fileDeleteIcon.addEventListener("click",(function(e){i.deleteFileOnClick(e)})),u.appendChild(i._fileDeleteIcon),n.appendChild(u)}i._fileListTBody.appendChild(n)},e.prototype.inputFileOnClick=function(){var e=this,t="",i="";this.findAndSetImageBackGround("loading",".gif",this._inputLabelElement),null!=this._inputFileElement.files&&(i=this._inputFileElement.files[0].name),this._inputLabelElement.innerText=i;var n=new FileReader;n.onload=function(){t=n.result,e._areFilesStoredOnSubEntity?e.createRecordInSubEntity(i,t):e.patchFileToRecord(e._parentRecordId,i,t)},null!=this._inputFileElement.files&&n.readAsDataURL(this._inputFileElement.files[0])},e.prototype.createRecordInSubEntity=function(e,t){var i=this,n=i._mainSubEntityFieldName,l=i._mappingFieldToRetrieveFiles+"@odata.bind",a={};a[n]=i._parentRecordId+"-"+Date.now(),i.isNullOrUndefined(i._fileTypeFieldName)||(a[i._fileTypeFieldName]=i._typeOfFile),a[l]="/"+i._parentEntityNamePlural+"("+i._parentRecordId+")",i._context.webAPI.createRecord(i._fileEntityName,a).then((function(n){i.patchFileToRecord(n.id.toString(),e,t)}),(function(e){i._context.navigation.openAlertDialog(e.message),console.log(e.message)}))},e.prototype.patchFileToRecord=function(e,t,i){var n=this,l=n._clientUrl+"/api/data/v9.1/"+n._fileEntityNamePlural+"("+e+")/"+n._fileFieldName,a=new XMLHttpRequest;a.open("PATCH",l),a.setRequestHeader("x-ms-file-name",t),a.setRequestHeader("Content-Type","application/octet-stream"),a.setRequestHeader("Content-Range","0-4095/8192"),a.setRequestHeader("Accept-Encoding","gzip, deflate"),a.setRequestHeader("OData-MaxVersion","4.0"),a.setRequestHeader("OData-Version","4.0"),a.onreadystatechange=function(){if(4===this.readyState){if(a.onreadystatechange=null,200===this.status||204===this.status)console.log("File Upload Done."),n.retrieveFileList(),n._inputFileElement.value="";else{var e=JSON.parse(this.response).error;console.log("Error : "+e.message),n._context.navigation.openAlertDialog(e.message),n._inputFileElement.value=""}n.retrieveFileList(),n._inputLabelElement.innerText="",n.showHideRelatedFilesOnClick("table")}},a.send(n._base64ToArrayBuffer(i))},e.prototype.deleteFileOnClick=function(e){var t=e.srcElement.id.split("_")[1],i=this;this.findAndSetImage("loading",".gif",e.srcElement);var n=i._clientUrl+"/api/data/v9.1/"+i._fileEntityNamePlural+"("+t+")/"+i._fileFieldName;i._areFilesStoredOnSubEntity&&(n=i._clientUrl+"/api/data/v9.1/"+i._fileEntityNamePlural+"("+t+")");var l=new XMLHttpRequest;l.open("DELETE",n),l.setRequestHeader("OData-MaxVersion","4.0"),l.setRequestHeader("OData-Version","4.0"),l.onreadystatechange=function(){if(4===this.readyState)if(l.onreadystatechange=null,200===this.status||204==this.status)i.retrieveFileList();else{var e=JSON.parse(this.response).error;i._context.navigation.openAlertDialog(e.message),console.log("Error : "+e.message)}},l.send(),console.log("deleting : "+t)},e.prototype.inputFileNameOnClick=function(e){var t=document.getElementById(e.srcElement.id).innerText,i=e.srcElement.id.split("_")[1],n=this,l=n._clientUrl+"/api/data/v9.1/"+n._fileEntityNamePlural+"("+i+")/"+n._fileFieldName+"/$value",a=new XMLHttpRequest;a.open("GET",l),a.setRequestHeader("Content-Type","application/octet-stream"),a.setRequestHeader("Content-Range","0-4095/8192"),a.setRequestHeader("Accept-Encoding","gzip, deflate"),a.setRequestHeader("OData-MaxVersion","4.0"),a.setRequestHeader("OData-Version","4.0"),a.onreadystatechange=function(){if(4===this.readyState)if(a.onreadystatechange=null,200===this.status){var e=a.responseText,i=n.base64MimeType(e),l=n.base64toBlob(e.split(",")[1],i);if(window.navigator.msSaveBlob)window.navigator.msSaveOrOpenBlob(l,t);else{var r=window.document.createElement("a");r.setAttribute("href",window.URL.createObjectURL(l)),r.setAttribute("download",t),n._fileListTBody.appendChild(r),r.click(),n._fileListTBody.removeChild(r)}}else{var o=JSON.parse(this.response).error;console.log("Error : "+o.message)}},a.send()},e.prototype._base64ToArrayBuffer=function(e){for(var t=e,i=t.length,n=new Uint8Array(i),l=0;l<i;l++)n[l]=t.charCodeAt(l);return n.buffer},e.prototype.base64toBlob=function(e,t){t=t||"";for(var i=atob(e),n=i.length,l=Math.ceil(n/1024),a=new Array(l),r=0;r<l;++r){for(var o=1024*r,s=Math.min(o+1024,n),d=new Array(s-o),c=o,p=0;c<s;++p,++c)d[p]=i[c].charCodeAt(0);a[r]=new Uint8Array(d)}return new Blob(a,{type:t})},e.prototype.base64MimeType=function(e){var t="",i=e.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);return i&&i.length&&(t=i[1]),t},e.prototype.findAndSetImage=function(e,t,i){var n=this;this._context.resources.getResource("img/"+e+t,(function(e){i.setAttribute("src",n.generateImageSrcUrl(t,e))}),(function(){console.log("Error when downloading "+e+t+" image.")}))},e.prototype.findAndSetImageBackGround=function(e,t,i){var n=this;this._context.resources.getResource("img/"+e+t,(function(e){i.style.backgroundImage="url("+n.generateImageSrcUrl(t,e)+")"}),(function(){console.log("Error when downloading "+e+t+" image.")}))},e.prototype.generateImageSrcUrl=function(e,t){return"data:image/"+e+";base64,"+t},e}();t.FileFieldTypeManager=n}]);
if (window.ComponentFramework && window.ComponentFramework.registerControl) {
	ComponentFramework.registerControl('Carfup.FileFieldTypeManager', pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad.FileFieldTypeManager);
} else {
	var Carfup = Carfup || {};
	Carfup.FileFieldTypeManager = pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad.FileFieldTypeManager;
	pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad = undefined;
}