{"properties":{"connectionReferences":{"shared_commondataserviceforapps_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnProject"},"api":{"name":"shared_commondataserviceforapps"}},"shared_office365_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnOutlook2"},"api":{"name":"shared_office365"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"},"FinanceTeam_EmailAddress":{"defaultValue":"samantha.j.pearmain@leidos.com","type":"String","metadata":{"schemaName":"leidos_FinanceTeam_EmailAddress"}}},"triggers":{"Project_Is_Approved":{"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"SubscribeWebhookTrigger","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"subscriptionRequest/message":3,"subscriptionRequest/entityname":"leidos_project","subscriptionRequest/scope":4,"subscriptionRequest/filteringattributes":"statuscode","subscriptionRequest/filterexpression":"(statuscode eq 445260001)","subscriptionRequest/runas":3},"authentication":"@parameters('$authentication')"}}},"actions":{"Perform_a_bound_action":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"PerformBoundAction","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_projects","actionName":"Microsoft.Dynamics.CRM.leidos_ProjectActionCallGenerateTransactionProcesssGenie","recordId":"@triggerOutputs()?['body/leidos_projectid']"},"authentication":"@parameters('$authentication')"}},"Update_Loans":{"actions":{"List_rows_of_Agreed_loans_on_Project":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_loans","fetchXml":"<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\" >\n  <entity name=\"leidos_loan\" >\n    <attribute name=\"leidos_loanid\" />\n    <filter type=\"and\" >\n      <condition attribute=\"statuscode\" operator=\"eq\" value=\"100000001\" />\n    </filter>\n    <link-entity name=\"leidos_projectfunding\" from=\"leidos_projectfundingid\" to=\"leidos_parentfunding\" link-type=\"inner\" alias=\"a_c2f18ff41f1deb11a8130022483fae82\" >\n      <attribute name=\"leidos_parentproject\" />\n      <link-entity name=\"leidos_projectcost\" from=\"leidos_projectcostid\" to=\"leidos_parentprojectcost\" link-type=\"inner\" alias=\"ak\" >\n        <link-entity name=\"leidos_project\" from=\"leidos_projectid\" to=\"leidos_parentproject\" link-type=\"inner\" alias=\"al\" >\n          <filter type=\"and\" >\n            <condition attribute=\"leidos_projectid\" operator=\"eq\" value=\"@{triggerOutputs()?['body/leidos_projectid']}\" />\n          </filter>\n        </link-entity>\n      </link-entity>\n    </link-entity>\n  </entity>\n</fetch>"},"authentication":"@parameters('$authentication')"},"description":"Set to Run After for any outcome to ensure it runs"},"Number_of_Loans":{"runAfter":{"List_rows_of_Agreed_loans_on_Project":["Succeeded"]},"type":"Compose","inputs":"@length(outputs('List_rows_of_Agreed_loans_on_Project')?['body/value'])"},"Loans_greater_than_one":{"actions":{"Get_Loan_ID":{"runAfter":{},"type":"Compose","inputs":"@First(outputs('List_rows_of_Agreed_loans_on_Project')?['body/value'])?['leidos_loanid']"},"Update_Loan_Status_to_Approved":{"runAfter":{"Get_Loan_ID":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_loans","recordId":"@outputs('Get_Loan_ID')","item/statecode":0,"item/statuscode":100000012},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Number_of_Loans":["Succeeded"]},"expression":{"greaterOrEquals":["@outputs('Number_of_Loans')",1]},"type":"If"}},"runAfter":{},"type":"Scope"},"Finance_Alert":{"actions":{"Get_Parent_Account":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"accounts","recordId":"@triggerOutputs()?['body/_leidos_parentaccount_value']"},"authentication":"@parameters('$authentication')"}},"Get_Support_item_Type":{"runAfter":{"Get_Parent_Account":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_supportitemtypes","recordId":"@triggerOutputs()?['body/_leidos_supportitemnfi_value']"},"authentication":"@parameters('$authentication')"}},"NFI":{"runAfter":{"Get_Support_item_Type":["Succeeded"]},"type":"Compose","inputs":"@outputs('Get_Support_item_Type')?['body/leidos_nfihidefeilds']"},"Supplier":{"runAfter":{"NFI":["Succeeded"]},"type":"Compose","inputs":"@outputs('Get_Parent_Account')?['body/leidos_suppliercode']"},"Condition":{"actions":{"Send_an_email_(V2)":{"runAfter":{"Get_Data":["Succeeded","Failed"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365_1","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@parameters('FinanceTeam_EmailAddress')","emailMessage/Subject":"New Client Set Up","emailMessage/Body":"<p><strong>Organisation Name </strong>: &nbsp;@{outputs('Get_Parent_Account')?['body/name']}<br>\n<strong>Organisation trading address postcode </strong>: &nbsp;@{outputs('Get_Parent_Account')?['body/address1_postalcode']}<br>\n<strong>Organisation trading address</strong> :,@{outputs('Get_Parent_Account')?['body/address1_line1']},@{outputs('Get_Parent_Account')?['body/address1_line2']},@{outputs('Get_Parent_Account')?['body/address1_line3']},@{outputs('Get_Parent_Account')?['body/address1_city']}<br>\n<strong>Legal Entity</strong> : @{outputs('Get_Legal_Entity')?['body/leidos_name']}<br>\n<strong>VAT Registration Number</strong> : &nbsp;@{outputs('Get_Parent_Account')?['body/leidos_vatnumber']}<br>\n<strong>Organisation Type </strong>: &nbsp;@{outputs('Get_Organization_Type')?['body/leidos_organisationtype']}<br>\n<strong>Primary Contact Email Address</strong> : &nbsp;@{outputs('Get_Primary_Contact')?['body/emailaddress1']}<br>\n<strong>MyHIE Account Reference Number</strong> :@{outputs('Get_Parent_Account')?['body/leidos_accountreference']}<br>\n<strong>Remittance Email Address</strong>: @{outputs('Get_Parent_Account')?['body/leidos_remittanceadviceemail']}<br>\n</p>"},"authentication":"@parameters('$authentication')"}},"Get_Data":{"actions":{"Get_Primary_Contact":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"contacts","recordId":"@outputs('Get_Parent_Account')?['body/_primarycontactid_value']"},"authentication":"@parameters('$authentication')"}},"Get_Legal_Entity":{"runAfter":{"Get_Primary_Contact":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_legalentities","recordId":"@outputs('Get_Parent_Account')?['body/_leidos_legalentity_value']"},"authentication":"@parameters('$authentication')"}},"Get_Organization_Type":{"runAfter":{"Get_Legal_Entity":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_organisationtypes","recordId":"@outputs('Get_Parent_Account')?['body/_leidos_organisationtype_value']"},"authentication":"@parameters('$authentication')"}}},"runAfter":{},"type":"Scope"}},"runAfter":{"Supplier":["Succeeded"]},"expression":{"and":[{"equals":["@outputs('Get_Support_item_Type')?['body/leidos_nfihidefeilds']",false]},{"equals":["@outputs('Get_Parent_Account')?['body/leidos_suppliercode']","@null"]}]},"type":"If"}},"runAfter":{},"type":"Scope"}},"outputs":{}}},"schemaVersion":"1.0.0.0"}