{"properties":{"connectionReferences":{"shared_commondataserviceforapps":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_sharedcommondataserviceforapps_5ec64"},"api":{"name":"shared_commondataserviceforapps"}},"shared_adobesign":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_sharedadobesign_30b2a"},"api":{"name":"shared_adobesign"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"On_Update_Submit_for__E_signature":{"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"SubscribeWebhookTrigger","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"subscriptionRequest/message":3,"subscriptionRequest/entityname":"leidos_legalundertaking","subscriptionRequest/scope":4,"subscriptionRequest/filteringattributes":"leidos_submitforesignature","subscriptionRequest/filterexpression":"leidos_submitforesignature eq true"},"authentication":"@parameters('$authentication')"}}},"actions":{"Get_Data_for_Adobe_Sign":{"actions":{"Compose":{"runAfter":{},"type":"Compose","inputs":"@triggerOutputs()?['body/leidos_clientsignatoryroute']"},"Get_DA_Table":{"runAfter":{"Compose":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_delegatedauthorityapprovaltables","recordId":"@triggerOutputs()?['body/_leidos_hiecontractsignatory_value']"},"authentication":"@parameters('$authentication')"}},"Get_DA_User":{"runAfter":{"Get_DA_Table":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@outputs('Get_DA_Table')?['body/_leidos_userrecord_value']"},"authentication":"@parameters('$authentication')"}},"Set_HIE_Signatory":{"runAfter":{"Get_DA_User":["Succeeded"]},"type":"SetVariable","inputs":{"name":"HIE Signatory Email Address","value":"@outputs('Get_DA_User')?['body/internalemailaddress']"}},"Get_Client_Signatory":{"runAfter":{"Compose":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"contacts","recordId":"@triggerOutputs()?['body/_leidos_clientcontact_value']"},"authentication":"@parameters('$authentication')"}},"Client_Email":{"runAfter":{"Get_Client_Signatory":["Succeeded"]},"type":"SetVariable","inputs":{"name":"Client Email Address","value":"@outputs('Get_Client_Signatory')?['body/emailaddress1']"}},"List_Notes":{"runAfter":{"Compose":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"annotations","fetchXml":"<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\">\n  <entity name=\"annotation\">\n    <attribute name=\"subject\" />\n    <attribute name=\"notetext\" />\n    <attribute name=\"filename\" />\n    <attribute name=\"annotationid\" />\n    <attribute name=\"isdocument\" />\n    <attribute name=\"filesize\" />\n    <order attribute=\"subject\" descending=\"false\" />\n    <filter type=\"and\">\n      <condition attribute=\"isdocument\" operator=\"eq\" value=\"1\" />\n    </filter>\n    <link-entity name=\"leidos_documentrequirement\" from=\"leidos_documentrequirementid\" to=\"objectid\" link-type=\"inner\" alias=\"an\">\n      <filter type=\"and\">\n        <condition attribute=\"leidos_requirementtype\" operator=\"eq\" value=\"445260002\" />\n      </filter>\n      <link-entity name=\"leidos_legalundertaking\" from=\"leidos_legalundertakingid\" to=\"leidos_legalundertaking\" link-type=\"inner\" alias=\"ao\">\n        <filter type=\"and\">\n          <condition attribute=\"leidos_legalundertakingid\" operator=\"eq\"  value=\"@{triggerOutputs()?['body/leidos_legalundertakingid']}\" />\n        </filter>\n      </link-entity>\n    </link-entity>\n  </entity>\n</fetch>"},"authentication":"@parameters('$authentication')"}},"Number_of_Returns":{"runAfter":{"List_Notes":["Succeeded"]},"type":"Compose","inputs":"@length(outputs('List_Notes')?['body/value'])"},"Condition":{"actions":{"Get_First_Note":{"runAfter":{},"type":"Compose","inputs":"@first(outputs('List_Notes')?['body/value'])"},"Parse_JSON":{"runAfter":{"Get_First_Note":["Succeeded"]},"type":"ParseJson","inputs":{"content":"@outputs('Get_First_Note')","schema":{"type":"object","properties":{"@@odata.type":{"type":"string"},"@@odata.id":{"type":"string"},"@@odata.etag":{"type":"string"},"@@odata.editLink":{"type":"string"},"filename":{"type":"string"},"annotationid@odata.type":{"type":"string"},"annotationid":{"type":"string"},"isdocument@OData.Community.Display.V1.FormattedValue":{"type":"string"},"isdocument":{"type":"boolean"},"filesize@OData.Community.Display.V1.FormattedValue":{"type":"string"},"filesize":{"type":"integer"}}}}},"Note_ID":{"runAfter":{"Parse_JSON":["Succeeded"]},"type":"Compose","inputs":"@body('Parse_JSON')?['annotationid']"},"Get_Note":{"runAfter":{"Note_ID":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"annotations","recordId":"@outputs('Note_ID')"},"authentication":"@parameters('$authentication')"}},"File_for_Signature":{"runAfter":{"Get_Note":["Succeeded"]},"type":"Compose","inputs":"@base64ToBinary(outputs('Get_Note')?['body/documentbody'])"},"Upload_a_document_and_get_a_document_ID":{"runAfter":{"File_for_Signature":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_adobesign","operationId":"CreateTransientDocument_V2","apiId":"/providers/Microsoft.PowerApps/apis/shared_adobesign"},"parameters":{"File-Name":"@outputs('Get_Note')?['body/filename']","File/body":"@outputs('File_for_Signature')"},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Number_of_Returns":["Succeeded"]},"else":{"actions":{"Reset":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_legalundertakings","recordId":"@triggerOutputs()?['body/leidos_legalundertakingid']","item/leidos_createanoteorsignature":false,"item/leidos_submitforesignature":false},"authentication":"@parameters('$authentication')"}},"Terminate":{"runAfter":{"Reset":["Succeeded"]},"type":"Terminate","inputs":{"runStatus":"Cancelled"}}}},"expression":{"greater":["@outputs('Number_of_Returns')",0]},"type":"If"}},"runAfter":{"Client_Signatory":["Succeeded"]},"type":"Scope"},"HIE_Signatory":{"runAfter":{},"type":"InitializeVariable","inputs":{"variables":[{"name":"HIE Signatory Email Address","type":"string"}]}},"Client_Signatory":{"runAfter":{"HIE_Signatory":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Client Email Address","type":"string"}]}},"Create_an_agreement_from_an_uploaded_document_and_send_for_signature":{"runAfter":{"Get_Data_for_Adobe_Sign":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_adobesign","operationId":"CreateAgreementById_V2","apiId":"/providers/Microsoft.PowerApps/apis/shared_adobesign"},"parameters":{"AgreementCreationInfoIdV6/name":"Legal Undertaking @{triggerOutputs()?['body/leidos_name']}","AgreementCreationInfoIdV6/fileInfos":[{"transientDocumentId":"@outputs('Upload_a_document_and_get_a_document_ID')?['body/transientDocumentId']"}],"AgreementCreationInfoIdV6/signatureType":"ESIGN","AgreementCreationInfoIdV6/participantSetsInfo":[{"memberInfos":[{"email":"@variables('HIE Signatory Email Address')"}],"order":1,"role":"SIGNER"},{"memberInfos":[{"email":"@variables('Client Email Address')"}],"order":2,"role":"SIGNER"}],"AgreementCreationInfoIdV6/message":"Please review and complete this document","AgreementCreationInfoIdV6/reminderFrequency":"WEEKLY_UNTIL_SIGNED"},"authentication":"@parameters('$authentication')"}},"When_an_agreement_workflow_is_completed_successfully":{"runAfter":{"Create_an_agreement_from_an_uploaded_document_and_send_for_signature":["Succeeded"]},"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_adobesign","operationId":"CreateWebhookForAgreementSignedEvent","apiId":"/providers/Microsoft.PowerApps/apis/shared_adobesign"},"parameters":{"WebhookCreationInfo/name":"Legal Undertaking @{triggerOutputs()?['body/leidos_name']}","WebhookCreationInfo/scope":"A specific agreement","WebhookCreationInfo/resourceId":"@outputs('Create_an_agreement_from_an_uploaded_document_and_send_for_signature')?['body/id']","WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeDetailedInfo":true,"WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeParticipantsInfo":true,"WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeDocumentsInfo":true,"WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeSignedDocuments":true},"authentication":"@parameters('$authentication')"}},"When_it_is_signed":{"runAfter":{"Create_an_agreement_from_an_uploaded_document_and_send_for_signature":["Succeeded"]},"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_adobesign","operationId":"CreateWebhookGeneric","apiId":"/providers/Microsoft.PowerApps/apis/shared_adobesign"},"parameters":{"WebhookCreationInfo/name":"Agreement is Signed","WebhookCreationInfo/scope":"A specific resource","WebhookCreationInfo/webhookSubscriptionEvents":["When a participant completes their action"],"WebhookCreationInfo/resourceType":"Agreement","WebhookCreationInfo/resourceId":"@outputs('Create_an_agreement_from_an_uploaded_document_and_send_for_signature')?['body/id']","WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeDetailedInfo":true,"WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeParticipantsInfo":true,"WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeDocumentsInfo":false,"WebhookCreationInfo/webhookConditionalParams/webhookAgreementEvents/includeSignedDocuments":false},"authentication":"@parameters('$authentication')"}},"Update_Legal_Undertaking_Date":{"runAfter":{"When_it_is_signed":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_legalundertakings","recordId":"@triggerOutputs()?['body/leidos_legalundertakingid']","item/leidos_dateissuedtoclient":"@utcNow()"},"authentication":"@parameters('$authentication')"}},"Update_Legal_Undertaking_Status_Reason":{"runAfter":{"Get_Data_for_Adobe_Sign":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_legalundertakings","recordId":"@triggerOutputs()?['body/leidos_legalundertakingid']","item/statecode":1,"item/statuscode":445260007},"authentication":"@parameters('$authentication')"}},"If_Scope_fails_Reset_the_Record":{"runAfter":{"Get_Data_for_Adobe_Sign":["Failed"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_legalundertakings","recordId":"@triggerOutputs()?['body/leidos_legalundertakingid']","item/leidos_createanoteorsignature":false,"item/statecode":0,"item/statuscode":445260003,"item/leidos_submitforesignature":false},"authentication":"@parameters('$authentication')"}},"Post_Receipt_Tasks":{"actions":{"Get_a_PDF_of_a_signed_agreement":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_adobesign","operationId":"GetCombinedDocument_V2","apiId":"/providers/Microsoft.PowerApps/apis/shared_adobesign"},"parameters":{"agreementId":"@outputs('Create_an_agreement_from_an_uploaded_document_and_send_for_signature')?['body/id']"},"authentication":"@parameters('$authentication')"}},"Create_Note_with_Attachment":{"runAfter":{"Get_a_PDF_of_a_signed_agreement":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"annotations","item/subject":"Signed Agreement PDF","item/notetext":"A PDF with the Signed Agreement","item/isdocument":true,"item/documentbody":"@base64(outputs('Get_a_PDF_of_a_signed_agreement')?['body'])","item/filename":"Signed Agreement.pdf","item/objectid_leidos_legalundertaking@odata.bind":"/leidos_legalundertakings(@{triggerOutputs()?['body/leidos_legalundertakingid']})"},"authentication":"@parameters('$authentication')"}},"Update_Legal_Undertaking_Status_Reason__to_Signed":{"runAfter":{"Get_a_PDF_of_a_signed_agreement":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_legalundertakings","recordId":"@triggerOutputs()?['body/leidos_legalundertakingid']","item/leidos_datedocumentsigned":"@utcNow()","item/statecode":0,"item/statuscode":445260008},"authentication":"@parameters('$authentication')"}},"Get_Owner":{"runAfter":{"Get_a_PDF_of_a_signed_agreement":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@triggerOutputs()?['body/_ownerid_value']"},"authentication":"@parameters('$authentication')"}},"Create_Email_for_Owner":{"runAfter":{"Get_Owner":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"emails","item/activitypointer_activity_parties":[{"participationtypemask":2,"partyid@odata.bind":"/systemusers(@{outputs('Get_Owner')?['body/systemuserid']})"}],"item/description":"Legal Undertaking Signed Documents have been received","item/regardingobjectid_leidos_legalundertaking_email@odata.bind":"/leidos_legalundertakings(@{triggerOutputs()?['body/leidos_legalundertakingid']})"},"authentication":"@parameters('$authentication')"}},"Send_Email":{"runAfter":{"Create_Email_for_Owner":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"PerformBoundAction","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"emails","actionName":"Microsoft.Dynamics.CRM.SendEmail","recordId":"@outputs('Create_Email_for_Owner')?['body/activityid']","item/IssueSend":true},"authentication":"@parameters('$authentication')"}}},"runAfter":{"When_an_agreement_workflow_is_completed_successfully":["Succeeded"]},"type":"Scope"}},"outputs":{}}},"schemaVersion":"1.0.0.0"}