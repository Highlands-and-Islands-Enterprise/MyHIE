{"properties":{"connectionReferences":{"shared_commondataserviceforapps":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_commondataserviceforapps"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"AMR_On_Change_of_Status_Reason":{"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"SubscribeWebhookTrigger","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"subscriptionRequest/message":3,"subscriptionRequest/entityname":"leidos_accountmanagementrecord","subscriptionRequest/scope":4,"subscriptionRequest/filteringattributes":"statuscode","subscriptionRequest/filterexpression":"statuscode eq 445260000 or statuscode eq 2"},"authentication":"@parameters('$authentication')"}}},"actions":{"Switch":{"runAfter":{"Get_Data":["Succeeded"]},"cases":{"Approved":{"case":445260000,"actions":{"Check_Segmentation":{"actions":{"Create_Draft_email_for__Contact":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"emails","item/activitypointer_activity_parties":[{"participationtypemask":2,"partyid@odata.bind":"/contacts(@{outputs('Contact')?['body/contactid']})"},{"participationtypemask":1,"partyid@odata.bind":"/systemusers(@{outputs('Account')?['body/_ownerid_value']})"}],"item/leidos_copyasportalmessage":true,"item/description":"<p>Dear @{outputs('Contact')?['body/firstname']}, <br>\n<br>\nHIE are pleased to formally confirm your appointed account manager to support you in furthering the aspirations of your organisation. I can confirm your account manager and contact details are as follows: <br>\n<br>\n<b>Account Manager Name :</b> @{outputs('Account_Owner')?['body/fullname']}<br>\n<b>Contact email:</b> @{outputs('Account_Owner')?['body/internalemailaddress']} <br>\n<b>Contact number: </b> @{outputs('Account_Owner')?['body/address1_telephone1']}<br>\n<br>\nAs an account managed client, for the terms of this engagement please visit <a href=\"https://www.hie.co.uk/legal/privacypolicy/\">HIE’s privacy statement </a> on our website. <br>\n<br>\nAccount Management is a two-way relationship and from time to time we will request information, both financial and non-financial, in order to provide the best possible support to your business and to ensure we meet our obligations as a public sector agency. Your co-operation with any such requests forms part of the ongoing Account Management relationship. <br>\n<br>\nIf you have any queries, please get in touch with us at: dataprotectionofficer@hient.co.uk. <br>\n<br>\nYour account manager will be in touch with you in due course, in the meantime if you have any questions don’t hesitate to get in touch. <br>\n<br>\n\nKind regards @{variables('Account Owner')}\n\n\n</p>","item/regardingobjectid_account_email@odata.bind":"/accounts(@{outputs('Account')?['body/accountid']})","item/statuscode":1,"item/subject":"Welcome to HIE"},"authentication":"@parameters('$authentication')"}},"Create_a_Task_to_begin_an_AMCP":{"runAfter":{"Create_Draft_email_for__Contact":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"tasks","item/subject":"Create Account Management Client Plan for  @{triggerOutputs()?['body/leidos_name']}","item/description":"@{outputs('Account')?['body/name']} has been approved for Account Management.  Please create the Client Plan and complete\n - Business Review\n - Growth Plan\n - Action Plan \n\n","item/scheduledend":"@addDays(utcNow(),90)","item/ownerid_task@odata.bind":"/systemusers(@{outputs('Account')?['body/_ownerid_value']})","item/regardingobjectid_leidos_accountmanagementrecord_task@odata.bind":"/leidos_accountmanagementrecords(@{triggerOutputs()?['body/leidos_accountmanagementrecordid']})"},"authentication":"@parameters('$authentication')"},"description":"Create task due in 90 Days"}},"runAfter":{},"else":{"actions":{"Create_Draft_email_for__Relationship_Managed":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"emails","item/activitypointer_activity_parties":[{"participationtypemask":2,"partyid@odata.bind":"/contacts(@{outputs('Contact')?['body/contactid']})"},{"participationtypemask":1,"partyid@odata.bind":"/systemusers(@{outputs('Account')?['body/_ownerid_value']})"}],"item/leidos_copyasportalmessage":true,"item/description":"<p>Dear @{outputs('Contact')?['body/firstname']}, <br>\n<br>\nHIE are pleased to formally confirm your appointed account manager to support you in furthering the aspirations of your organisation. I can confirm your account manager and contact details are as follows: <br>\n<br>\n<b>Account Manager Name :</b> @{outputs('Account_Owner')?['body/fullname']}<br>\n<b>Contact email:</b> @{outputs('Account_Owner')?['body/internalemailaddress']} <br>\n<b>Contact number: </b> @{outputs('Account_Owner')?['body/address1_telephone1']}<br>\n<br>\nAs an account managed client, for the terms of this engagement please visit <a href=\"https://www.hie.co.uk/legal/privacypolicy/\">HIE’s privacy statement </a> on our website. <br>\n<br>\nAccount Management is a two-way relationship and from time to time we will request information, both financial and non-financial, in order to provide the best possible support to your business and to ensure we meet our obligations as a public sector agency. Your co-operation with any such requests forms part of the ongoing Account Management relationship. <br>\n<br>\nIf you have any queries, please get in touch with us at: dataprotectionofficer@hient.co.uk. <br>\n<br>\nYour account manager will be in touch with you in due course, in the meantime if you have any questions don’t hesitate to get in touch. <br>\n<br>\n\nKind regards @{variables('Account Owner')}\n\n\n</p>","item/regardingobjectid_account_email@odata.bind":"/accounts(@{outputs('Account')?['body/accountid']})","item/statuscode":1,"item/subject":"Welcome to HIE Relationship Management"},"authentication":"@parameters('$authentication')"}},"Create_a_Task_to_Complete_Relationship_Managed":{"runAfter":{"Create_Draft_email_for__Relationship_Managed":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"tasks","item/subject":" @{triggerOutputs()?['body/leidos_name']} Relationaship Managed","item/description":"@{outputs('Account')?['body/name']} has been approved for Account Management.  The Account is Relationship Managed so an Account Management Client Plan is not required.\n\nPlease complete the following within the Account Record\n - Trading Income and Turn Over\n - Number of FTE Employees\n - Number of Employees\n\n","item/scheduledend":"@addDays(utcNow(), 90)","item/ownerid_task@odata.bind":"/systemusers(@{outputs('Account')?['body/_ownerid_value']})","item/regardingobjectid_account_task@odata.bind":"/accounts(@{outputs('Account')?['body/accountid']})"},"authentication":"@parameters('$authentication')"},"description":"Create task due in 90 Days"},"Update_AMR_Clear_Reminder":{"runAfter":{"Create_a_Task_to_Complete_Relationship_Managed":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_accountmanagementrecords","recordId":"@triggerOutputs()?['body/leidos_accountmanagementrecordid']","item/leidos_businessreviewreminderdate":"@null"},"authentication":"@parameters('$authentication')"}}}},"expression":{"not":{"equals":["@outputs('Get_Proposed_Segmentation')?['body/leidos_relationshipmanaged']",true]}},"type":"If"}}},"Completed":{"case":2,"actions":{"Create_Disengagement_Email":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"emails","item/activitypointer_activity_parties":[{"participationtypemask":2,"partyid@odata.bind":"/contacts(@{outputs('Contact')?['body/contactid']})"},{"participationtypemask":1,"partyid@odata.bind":"/systemusers(@{outputs('Account')?['body/_ownerid_value']})"}],"item/leidos_copyasportalmessage":true,"item/description":"Dear @{outputs('Contact')?['body/firstname']}<br>\n<p>\nAs detailed in our terms of engagement letter we will from time to time review our relationship with account managed client. As discussed at our meeting on insert date you will no longer be formally account managed by HIE at this time. </p>\n<p>\n(If signposting) I would like to advise that Business Gateway/Just Enterprise/other is the agency that is best placed to provide you with advice and other support services at this time.</p>\n<p>\n(Examples for Business gateway/Just enterprise below - delete as appropriate. If neither is the right fit for the client, please use your judgment to decide what is best if signposting is not appropriate i.e. for a large company)\nBusiness Gateway offers free access to a range of professional resources, support and tools to help you learn new skills, create new opportunities and develop sustainable strategies for growth</p>\n<p>\nJust Enterprise is a support programme to help and support social enterprises and social entrepreneurs achieve their trading ambitions.</p>\n<p>\nYour local Business Gateway contact is:<br>\nName<br>\nEmail<br>\nPhone Number <br>\n</p>\n<p>\nYour organisation will no longer appear on the monthly published account management list. However, if your circumstances change and there is an opportunity for HIE to help support accelerated growth/growth ambitions, Business Gateway/other will discuss your plans with us to ascertain if there are any areas that HIE would be able to support. </p>\n<p>\nI would like to take this opportunity to thank you for your ongoing contribution to the region’s economy, and wish you and your organisation every success in the future.</p>\n\n@{variables('Account Owner')}\n\n","item/regardingobjectid_account_email@odata.bind":"/accounts(@{outputs('Account')?['body/accountid']})","item/subject":"Disengagement from Highlands and Islands Account Management"},"authentication":"@parameters('$authentication')"}},"Update_AMR_with_End_Date":{"runAfter":{"Create_Disengagement_Email":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_accountmanagementrecords","recordId":"@triggerOutputs()?['body/leidos_accountmanagementrecordid']","item/leidos_amrenddate":"@utcNow()"},"authentication":"@parameters('$authentication')"}}}}},"default":{"actions":{}},"expression":"@triggerOutputs()?['body/statuscode']","type":"Switch"},"Get_Data":{"actions":{"Run_a_Child_Flow":{"runAfter":{},"type":"Workflow","inputs":{"host":{"workflowReferenceName":"b0db1a8a-c449-ea11-a812-000d3a0ba151"},"body":{"EntityId_Inputs":"@triggerOutputs()?['body/leidos_accountmanagementrecordid']","EntityType_Value":"leidos_accountmanagementrecord"}}},"Account":{"runAfter":{"Run_a_Child_Flow":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"accounts","recordId":"@triggerOutputs()?['body/_leidos_parentaccount_value']"},"authentication":"@parameters('$authentication')"}},"Contact":{"runAfter":{"Get_Proposed_Segmentation":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"contacts","recordId":"@outputs('Account')?['body/_primarycontactid_value']"},"authentication":"@parameters('$authentication')"}},"Condition":{"actions":{"Get_a_record":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"teams","recordId":"@outputs('Account')?['body/_ownerid_value']"},"authentication":"@parameters('$authentication')"}},"Set_Owner_to_team_Name":{"runAfter":{"Get_a_record":["Succeeded"]},"type":"SetVariable","inputs":{"name":"Account Owner","value":"@outputs('Get_a_record')?['body/name']"}}},"runAfter":{"Contact":["Succeeded"]},"else":{"actions":{"Account_Owner":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@outputs('Account')?['body/_ownerid_value']"},"authentication":"@parameters('$authentication')"}},"Set_owner_to_Contact_Full_Name":{"runAfter":{"Account_Owner":["Succeeded"]},"type":"SetVariable","inputs":{"name":"Account Owner","value":"@outputs('Account_Owner')?['body/fullname']"}}}},"expression":{"equals":["@outputs('Account')?['body/_ownerid_value@Microsoft.Dynamics.CRM.lookuplogicalname']","team"]},"type":"If"},"Get_Proposed_Segmentation":{"runAfter":{"Account":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_segmentations","recordId":"@triggerOutputs()?['body/_leidos_proposedsegmentation_value']"},"authentication":"@parameters('$authentication')"}},"Compose":{"runAfter":{"Get_Proposed_Segmentation":["Succeeded"]},"type":"Compose","inputs":"@outputs('Get_Proposed_Segmentation')?['body/leidos_relationshipmanaged']"}},"runAfter":{"Initialize_variable":["Succeeded"]},"type":"Scope"},"Initialize_variable":{"runAfter":{},"type":"InitializeVariable","inputs":{"variables":[{"name":"Account Owner","type":"string","value":"Highland and Islands Enterprise"}]}}},"outputs":{}}},"schemaVersion":"1.0.0.0"}