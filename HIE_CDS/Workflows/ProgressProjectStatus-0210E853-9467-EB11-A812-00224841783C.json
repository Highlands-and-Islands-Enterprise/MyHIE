{"properties":{"connectionReferences":{"shared_commondataservice":{"runtimeSource":"invoker","connection":{"connectionReferenceLogicalName":"leidos_sharedcommondataservice_55fe7"},"api":{"name":"shared_commondataservice"}},"shared_commondataserviceforapps_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnProject"},"api":{"name":"shared_commondataserviceforapps"}},"shared_office365_1":{"runtimeSource":"invoker","connection":{"connectionReferenceLogicalName":"leidos_ConnOutlook2"},"api":{"name":"shared_office365"}},"shared_office365users":{"runtimeSource":"invoker","connection":{"connectionReferenceLogicalName":"leidos_sharedoffice365users_391f8"},"api":{"name":"shared_office365users"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"manual":{"splitOn":"@triggerBody()['rows']","type":"Request","kind":"ApiConnection","inputs":{"schema":{"type":"object","properties":{"rows":{"type":"array","items":{"type":"object","properties":{"entity":{"type":"object","properties":{"_ownerid_value":{"title":"Owner","type":"string","format":"guid"},"leidos_projectid":{"title":"Project","type":"string","format":"guid"}},"required":["_ownerid_value","leidos_projectid"]}},"required":["entity"]}}},"required":["rows"]},"host":{"connection":{"name":"@parameters('$connections')['shared_commondataservice']['connectionId']"}},"operationId":"GetOnNewItems_V2","parameters":{"dataset":"default.cds","table":"leidos_projects"}}}},"actions":{"Initialize_Owner_Email_variable":{"runAfter":{"Get_my_profile_(V2)":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Owner Email","type":"string"}]}},"Scope_-_Get_Data":{"actions":{"Set_Owner_Email_variable":{"runAfter":{"Get_Owner":["Succeeded"]},"type":"SetVariable","inputs":{"name":"Owner Email","value":"@outputs('Get_Owner')?['body/internalemailaddress']"}},"Get_Project_Details":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_projects","recordId":"@triggerBody()?['entity']?['leidos_projectid']"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}},"Get_Owner":{"runAfter":{"Get_Project_Details":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@triggerBody()?['entity']?['_ownerid_value']"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}}},"runAfter":{"Initialize_Owner_Email_variable":["Succeeded"]},"type":"Scope"},"Switch_Current_Project_Status_Reason":{"runAfter":{"Scope_-_Get_Data":["Succeeded"]},"cases":{"Case_Clear_to_Pay_to_Claims_Complete":{"case":445260013,"actions":{"Update_Project_to_Claims_Complete":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_projects","recordId":"@triggerBody()?['entity']?['leidos_projectid']","item/statecode":0,"item/statuscode":445260002},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}},"Send_an_email_(V2)":{"runAfter":{"Update_Project_to_Claims_Complete":["Failed"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365_1","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@{outputs('Get_my_profile_(V2)')?['body/mail']}; @{variables('Owner Email')}","emailMessage/Subject":"Project Status Change Failure","emailMessage/Body":"<p>Project: @{triggerBody()?['entity']?['leidos_projectreference']} &nbsp;@{triggerBody()?['entity']?['leidos_name']}<br>\n<br>\nProject failed to update to status <strong>Claims Complete</strong>.<br>\n<strong><br>\n</strong>Please review status of project is Clear to pay and all required data has been entered before moving to Claims Complete.<br>\n</p>"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}}}},"Case_Claims_Complete_to_Project_Complete":{"case":445260002,"actions":{"Update_Project_to_Project_Complete":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"UpdateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_projects","recordId":"@triggerBody()?['entity']?['leidos_projectid']","item/statecode":1,"item/statuscode":2},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}},"Send_an_email_(V2)_2":{"runAfter":{"Update_Project_to_Project_Complete":["Failed"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365_1","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@{outputs('Get_my_profile_(V2)')?['body/mail']}; @{variables('Owner Email')}","emailMessage/Subject":"Project Status Change Failure","emailMessage/Body":"<p><strong>Project: </strong><strong>@{triggerBody()?['entity']?['leidos_projectreference']}</strong><strong> &nbsp;</strong><strong>@{triggerBody()?['entity']?['leidos_name']}</strong><strong></strong><br>\n<br>\nProject failed to update to status <strong>Project Complete</strong>.<strong><br>\n<br>\n</strong>Please review status of project is Claims Complete and measurement Actual values have been entered.<strong><br>\n</strong></p>"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}}}}},"default":{"actions":{"Terminate":{"runAfter":{"Send_an_email_(V2)_3":["Succeeded"]},"type":"Terminate","inputs":{"runStatus":"Cancelled"}},"Send_an_email_(V2)_3":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365_1","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@{outputs('Get_my_profile_(V2)')?['body/mail']} ; @{variables('Owner Email')}","emailMessage/Subject":"Project Status Change Attempt","emailMessage/Body":"<p>Project: @{triggerBody()?['entity']?['leidos_projectreference']} &nbsp;@{triggerBody()?['entity']?['leidos_name']}<br>\n<br>\nThere was an attempt to progress the status of the above Project by @{outputs('Get_my_profile_(V2)')?['body/displayName']}.<br>\n<br>\nThe change in status faild to progress as the Project is not at status Clear to Pay or Claims Complete.<br>\n</p>"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}}}},"expression":"@outputs('Get_Project_Details')?['body/statuscode']","type":"Switch"},"Get_my_profile_(V2)":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365users","operationId":"MyProfile_V2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365users"},"parameters":{},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}}}},"outputs":{}}},"schemaVersion":"1.0.0.0"}