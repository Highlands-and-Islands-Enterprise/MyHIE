{"properties":{"connectionReferences":{"shared_commondataserviceforapps_2":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnProjectAmendment"},"api":{"name":"shared_commondataserviceforapps"}},"shared_commondataserviceforapps_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnProgrammeAmendment"},"api":{"name":"shared_commondataserviceforapps"}},"shared_office365_1":{"runtimeSource":"embedded","connection":{"connectionReferenceLogicalName":"leidos_ConnOutlook2"},"api":{"name":"shared_office365"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"Recurrence":{"recurrence":{"frequency":"Day","interval":1,"schedule":{"hours":["0"],"minutes":[15]}},"type":"Recurrence"}},"actions":{"List_Project_Amendment_Rows":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_2","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_projectamendments","fetchXml":"<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\">\n  <entity name=\"leidos_projectamendment\">\n    <attribute name=\"leidos_projectamendmentid\" />\n    <attribute name=\"leidos_name\" />\n    <attribute name=\"leidos_projectamendmentreference\" />\n    <attribute name=\"leidos_project\" />\n    <attribute name=\"leidos_budgetsubtype\" />\n    <attribute name=\"leidos_amendmenttype\" />\n    <attribute name=\"leidos_amendmentdocumentlink\" />\n    <order attribute=\"leidos_name\" descending=\"false\" />\n    <filter type=\"and\">\n      <condition attribute=\"statuscode\" operator=\"eq\" value=\"445260002\" />\n      <condition attribute=\"modifiedon\" operator=\"yesterday\" />\n    </filter>\n  </entity>\n</fetch>"},"authentication":"@parameters('$authentication')"}},"Apply_to_each":{"foreach":"@outputs('List_Project_Amendment_Rows')?['body/value']","actions":{"Run_a_Child_Flow_-_Project_Amendment":{"runAfter":{"Get_Project_Row":["Succeeded"]},"type":"Workflow","inputs":{"host":{"workflowReferenceName":"b0db1a8a-c449-ea11-a812-000d3a0ba151"},"body":{"EntityId_Inputs":"@items('Apply_to_each')?['leidos_projectamendmentid']","EntityType_Value":"leidos_projectamendment"}}},"Run_a_Child_Flow_-_Project":{"runAfter":{"Run_a_Child_Flow_-_Project_Amendment":["Succeeded"]},"type":"Workflow","inputs":{"host":{"workflowReferenceName":"b0db1a8a-c449-ea11-a812-000d3a0ba151"},"body":{"EntityId_Inputs":"@items('Apply_to_each')?['_leidos_project_value']","EntityType_Value":"leidos_project"}}},"Append_to_array_variable":{"runAfter":{"Compose_Project_URL":["Succeeded"]},"type":"AppendToArrayVariable","inputs":{"name":"HTML Table","value":{"Project Amendment Reference":"@items('Apply_to_each')?['leidos_projectamendmentreference']","Project Amendment":"@outputs('Compose_Project_Amendment_URL')","Amendment Type":"@variables('Amendment Type')","Project":"@outputs('Compose_Project_URL')","Amendment Document":"@items('Apply_to_each')?['leidos_amendmentdocumentlink']"}}},"Switch_Amendment_Type":{"runAfter":{},"cases":{"Case_-_Cost_Type":{"case":445260000,"actions":{"Set_variable_AT_-_Cost_Type":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Amendment Type","value":"Cost Type"}}}},"Case_-_Project":{"case":445260001,"actions":{"_Set_variable_AT_-_Project":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Amendment Type","value":"Project"}}}},"Case_-_Budget_Subtype":{"case":445260002,"actions":{"Set_variable_AT_-_Budget_Subtype":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Amendment Type","value":"Budget Sub-type"}}}},"Case_-_Revert_Clear_to_Pay":{"case":445260003,"actions":{"Set_variable_Revert_Clear_to_Pay":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Amendment Type","value":"Revert Clear to Pay"}}}}},"default":{"actions":{"Set_variable":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Amendment Type","value":"Not known"}}}},"expression":"@items('Apply_to_each')?['leidos_amendmenttype']","type":"Switch"},"Get_Project_Row":{"runAfter":{"Switch_Amendment_Type":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"leidos_projects","recordId":"@items('Apply_to_each')?['_leidos_project_value']","$select":"leidos_name"},"authentication":"@parameters('$authentication')"}},"Compose_Project_URL":{"runAfter":{"Compose_Project_Amendment_URL":["Succeeded"]},"type":"Compose","inputs":"URL1@{outputs('Run_a_Child_Flow_-_Project')?['Body']?['entityurl']}URL2@{outputs('Get_Project_Row')?['body/leidos_name']} URL3"},"Compose_Project_Amendment_URL":{"runAfter":{"Run_a_Child_Flow_-_Project":["Succeeded"]},"type":"Compose","inputs":"URL1@{outputs('Run_a_Child_Flow_-_Project_Amendment')?['Body']?['entityurl']}URL2@{items('Apply_to_each')?['leidos_name']} URL3"}},"runAfter":{"_Scope_Get_Data":["Succeeded"]},"type":"Foreach"},"Send_an_email_(V2)":{"runAfter":{"Compose_URL_3":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365_1","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":"@variables('Finance Emails')","emailMessage/Subject":"@{variables('Project Amendment Record Count')} Project Amendments Approved on @{addDays(utcNow(),-1,'dd/MM/yy')}","emailMessage/Body":"<p>Dear Finance,<br>\n<br>\nMyHIE Project Amendments Approved on @{addDays(utcNow(),-1,'dd/MM/yy')}:<br>\n<br>\n@{outputs('Compose_URL_3')}<br>\n<br>\n</p>"},"authentication":"@parameters('$authentication')"}},"Initialize_variable_Record_Count":{"runAfter":{"List_Project_Amendment_Rows":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Project Amendment Record Count","type":"integer","value":0}]}},"Initialize_variable_Finance_Email":{"runAfter":{"Initialize_variable_Record_Count":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Finance Emails","type":"string"}]}},"Create_HTML_table":{"runAfter":{"Apply_to_each":["Succeeded"]},"type":"Table","inputs":{"from":"@variables('HTML Table')","format":"HTML"}},"_Scope_Get_Data":{"actions":{"Set_variable_Record_Count":{"runAfter":{},"type":"SetVariable","inputs":{"name":"Project Amendment Record Count","value":"@length(outputs('List_Project_Amendment_Rows')?['body/value'])"}},"Set_variable_Finance_Email":{"runAfter":{"Run_a_Child_Flow_Finance_Email":["Succeeded"]},"type":"SetVariable","inputs":{"name":"Finance Emails","value":"@outputs('Run_a_Child_Flow_Finance_Email')?['Body']?['value']"}},"Run_a_Child_Flow_Finance_Email":{"runAfter":{"Set_variable_Record_Count":["Succeeded"]},"type":"Workflow","inputs":{"host":{"workflowReferenceName":"30095a04-574e-ea11-a812-000d3a7f1bbb"},"body":{"EnvironmentVariable_Inputs":"FinanceTeam_EmailAddress"}}}},"runAfter":{"Initialize_variable_HTML_Table_Array":["Succeeded"]},"type":"Scope"},"Initialize_variable_Amendment_Type":{"runAfter":{"Initialize_variable_Finance_Email":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"Amendment Type","type":"string"}]}},"Initialize_variable_HTML_Table_Array":{"runAfter":{"Initialize_variable_Amendment_Type":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"HTML Table","type":"array"}]}},"Compose_URL_1":{"runAfter":{"Create_HTML_table":["Succeeded"]},"type":"Compose","inputs":"@replace(body('Create_HTML_table'),'URL1','<a href=\"')"},"Compose_URL_2":{"runAfter":{"Compose_URL_1":["Succeeded"]},"type":"Compose","inputs":"@replace(outputs('Compose_URL_1'),'URL2','\">')"},"Compose_URL_3":{"runAfter":{"Compose_URL_2":["Succeeded"]},"type":"Compose","inputs":"@replace(outputs('Compose_URL_2'),'URL3','</a>')"}},"outputs":{}}},"schemaVersion":"1.0.0.0"}